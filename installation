 1. change the SSH port to 2222
 https://docs.bitnami.com/aws/apps/gitlab/administration/create-ssl-certificate-nginx/
 2. Create a folder /srv
 3. CD /srv
 4. mkdir -p /srv/gitlab-geo/gitlab/{config,data,logs}
 5. cd /srv/gitlab-geo/gitlab/
 6. ls -la
 7. ln -s /srv /gitlab-geo/gitlab/config /root
 8. cd /srv/gitlab-geo/gitlab/
 9. Build a docker image with my domain's wildcard certificate
 10. FROM gitlab/gitlab-ee:latest

    COPY ca_serv.crt /usr/local/share/ca-certificates/

    RUN update-ca-certificates &&\
    echo 'Match User git' >> /etc/ssh/sshd_config &&\
    echo ' AuthorizedKeysCommand /opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell-authorized-keys-check' >> /etc/ssh/sshd_config &&\
    echo ' AuthorizedKeysCommandUser git' >> /etc/ssh/sshd_config &&\
    echo 'Match all' >> /etc/ssh/sshd_config

11. docker build . -t gitlab/gitlab-16.11
12. cp compose.yml /srv/gitlab-geo/
13. vim compose.yml
14  GITLAB_OMNIAUTH_CONFIG: |
        external_url:    'https://primary.7homes.com'

    ports:
        - "443:443"
        - "80:80"
        - "22:22"
        - '54321:54321'

15. docker compose up -d
16. docker compose logs -f
17. cd ~/gitlab-geo/gitlab/config/trusted-certs
18. cp our wildcard certificate to trusted-certs
19. rm ~/gitlab-geo/gitlab/config/ssl/*
20. cp our wildcard certificate to ssl
21. vim /root/gitlab-geo/gitlab/config/gitlab.rb
22. disable the letsencrypt
23. docker exec -it gitlab-geo-web-1 bash
24. gitlab-ctl status
25. gitlab-ctl reconfigure
26. gitlab-ctl restart
27. login to gitlab in web and crack the gitlab_server
28. edit /root/gitlab-geo/gitlab/config/gitlab.rb
29. gitlab_rails['geo_node_name'] = 'primary'
30. docker exec -it gitlab-geo-web-1 bash
31. gitlab-ctl reconfigure
32. gitlab-ctl restart
gitlab-ctl set-geo-primary-node
33. check the gitlab-geo-web-1 is now the primary Geo node
34. Back to web server to check the gitlab-geo-web-1 is now the primary Geo node
gitlab-ctl pg-password-md5 gitlab
35. gitlab-ctl pg-password-md5 gitlab
36. gitlab-ctl pg-password-md5 gitlab_replicator
35. vim /root/gitlab-geo/gitlab/config/gitlab.rb
36. vim /root/gitlab-geo/gitlab/config/gitlab.rb
37. postgresql['sql_user_password'] = 'gitlab-geo-web-1 hash'
38. gitlab_rails['db_password'] = 'gitlab-geo-web-1'
39. postgresql['sql_replication_password'] = 'gitlab-geo-web-2 hash'
40. postgresql['md5_auth_cidr_address'] = ['192.168.XX.XX/32', '192.168.XX.XX/32']
41. postgresql['trust_auth_cidr_address'] = ['192.168.XX.XX/32', '192.168.XX.XX/32']
42. postgresql['listen_address'] = 'gitlab-geo-web-1'
43. gitlab_rails['auto_migrate] = false
44. postgresql['max_replication_slots'] = 1
45. gitlab-ctl reconfigure
46. gitlab-ctl restart postgresql
47. vim /root/gitlab-geo/gitlab/config/gitlab.rb
48. gitlab_rails['auto_migrate] = false
49. gitlab-ctl reconfigure
50. vim /root/gitlab-geo/gitlab/config/gitlab.rb
51. roles['geo_primary_role']
52. gitlab-rake gitlab:check
53. Gitlab configured to disable writing to authorized_keys file .. no (CHECK THIS)
54. On the gitlab web go to Geo site and check the primary node
55. go to setting --> Network --> Performance optimization UNCHECK Use_authorized_keys file to authenticate SSH keys
56. gitlab-rake gitlab:geo:check







